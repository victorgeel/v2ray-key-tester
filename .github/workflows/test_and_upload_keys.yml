name: Test V2Ray Keys and Upload to R2

on:
  schedule:
    # Runs every hour (adjust as needed)
    - cron: '0 * * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  test-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Or newer version

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Run V2Ray Key Tester Script
        run: python scripts/test_v2ray_keys.py

      - name: Install rclone # Tool to interact with R2
        run: |
          sudo apt-get update && sudo apt-get install -y rclone

      - name: Configure rclone for Cloudflare R2
        env:
          # Get credentials from GitHub Secrets
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          # Get R2 endpoint and bucket info from Secrets or define here if public
          # The R2 endpoint depends on your account ID. Find it in R2 dashboard.
          # Format: https://<ACCOUNT_ID>.r2.cloudflarestorage.com
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }} # e.g., v2ray-working-keys
        run: |
          rclone config create R2 s3 \
            provider=Cloudflare \
            access_key_id=$R2_ACCESS_KEY_ID \
            secret_access_key=$R2_SECRET_ACCESS_KEY \
            endpoint=$R2_ENDPOINT \
            acl=public-read # Make uploaded files public automatically

      - name: Upload working key files to R2 Bucket
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          # Sync the output directory to the root of the R2 bucket
          # This will upload new/changed files and delete files in R2 that are not in output/
          # Use --verbose for more detailed logs
          rclone sync ./output R2:${R2_BUCKET_NAME}/ --progress --verbose

      - name: Clean up output directory (optional)
        run: rm -rf ./output
        
